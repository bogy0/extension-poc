<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamCenter - Drag & Drop POC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .elements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .element-card {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 20px;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .element-card:hover {
            border-color: #0066cc;
            background: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.2);
        }
        
        .element-card:active {
            cursor: grabbing;
            transform: scale(0.98);
        }
        
        .element-card.dragging {
            opacity: 0.6;
            transform: rotate(5deg);
        }
        
        .element-type {
            font-weight: 600;
            color: #0066cc;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .element-name {
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
        }
        
        .element-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .instructions {
            background: #e8f4fd;
            border: 1px solid #b3d9f2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            color: #0066cc;
            margin-bottom: 8px;
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .debug-info h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .debug-log {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">
            üè¢ TeamCenter Elements
        </div>
        <div class="connection-status" id="connectionStatus">
            <span id="connectionIcon">‚è≥</span>
            <span id="connectionText">Connecting to Rhapsody...</span>
        </div>
    </div>

    <div class="main-content">
        <div class="instructions">
            <h3>Instructions</h3>
            <p>Drag the elements below to the Rhapsody application to create new SysML elements. The connection status above shows your current connection to Rhapsody.</p>
        </div>

        <div class="elements-grid">
            <div class="element-card" draggable="true" data-element-type="PartUsage" data-element-id="TC001">
                <div class="element-type">PartUsage</div>
                <div class="element-name">Motor Assembly</div>
                <div class="element-description">A high-performance electric motor assembly designed for automotive applications. Includes rotor, stator, and control electronics.</div>
            </div>

            <div class="element-card" draggable="true" data-element-type="RequirementUsage" data-element-id="TC002">
                <div class="element-type">RequirementUsage</div>
                <div class="element-name">Performance Requirement</div>
                <div class="element-description">The system shall achieve a minimum efficiency of 95% under standard operating conditions with maximum power output of 150kW.</div>
            </div>

            <div class="element-card" draggable="true" data-element-type="ActionUsage" data-element-id="TC003">
                <div class="element-type">ActionUsage</div>
                <div class="element-name">Start Engine Sequence</div>
                <div class="element-description">Complete sequence for starting the engine including pre-checks, ignition, and warm-up procedures.</div>
            </div>

            <div class="element-card" draggable="true" data-element-type="InterfaceUsage" data-element-id="TC004">
                <div class="element-type">InterfaceUsage</div>
                <div class="element-name">CAN Bus Interface</div>
                <div class="element-description">Controller Area Network interface for communication between ECUs with 500kbps data rate and error handling.</div>
            </div>

            <div class="element-card" draggable="true" data-element-type="ItemUsage" data-element-id="TC005">
                <div class="element-type">ItemUsage</div>
                <div class="element-name">Brake Fluid</div>
                <div class="element-description">DOT 4 brake fluid with high boiling point and corrosion inhibitors for hydraulic brake systems.</div>
            </div>

            <div class="element-card" draggable="true" data-element-type="PortUsage" data-element-id="TC006">
                <div class="element-type">PortUsage</div>
                <div class="element-name">Power Input Port</div>
                <div class="element-description">12V DC power input port with overcurrent protection and reverse polarity protection.</div>
            </div>
        </div>

        <div class="debug-info">
            <h4>Debug Information</h4>
            <div class="debug-log" id="debugLog"></div>
        </div>
    </div>

    <script>
        // Debug logging function
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const logMessage = `[${timestamp}] ${message}\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[TeamCenter] ${message}`);
        }

        // Connection state management
        let isConnectedToRhapsody = false;
        let rhapsodyWindow = null;

        function updateConnectionStatus(status, text) {
            const statusElement = document.getElementById('connectionStatus');
            const iconElement = document.getElementById('connectionIcon');
            const textElement = document.getElementById('connectionText');
            
            statusElement.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    iconElement.textContent = '‚úÖ';
                    break;
                case 'disconnected':
                    iconElement.textContent = '‚ùå';
                    break;
                case 'connecting':
                    iconElement.textContent = '‚è≥';
                    break;
            }
            
            textElement.textContent = text;
            debugLog(`Connection status: ${status} - ${text}`);
        }

        // Initialize connection detection
        function initializeConnection() {
            debugLog('Initializing TeamCenter application...');
            debugLog(`Window opener: ${window.opener ? 'Present' : 'Not present'}`);
            debugLog(`Window parent: ${window.parent !== window ? 'Present' : 'Not present'}`);
            
            // Check if opened by Rhapsody
            if (window.opener) {
                debugLog('Detected window.opener - sending TEAMCENTER_READY message');
                rhapsodyWindow = window.opener;
                
                // Send ready message to Rhapsody
                rhapsodyWindow.postMessage({
                    type: 'TEAMCENTER_READY',
                    source: 'TeamCenter',
                    timestamp: Date.now()
                }, '*');
                
                updateConnectionStatus('connecting', 'Connecting to Rhapsody...');
                
                // Set a timeout to check connection
                setTimeout(() => {
                    if (!isConnectedToRhapsody) {
                        updateConnectionStatus('disconnected', 'Not connected to Rhapsody');
                        debugLog('Connection timeout - no response from Rhapsody');
                    }
                }, 5000);
            } else {
                updateConnectionStatus('disconnected', 'Not opened by Rhapsody');
                debugLog('Not opened by Rhapsody - standalone mode');
            }
        }

        // Listen for messages from Rhapsody
        window.addEventListener('message', function(event) {
            debugLog(`Received message: ${JSON.stringify(event.data)} from origin: ${event.origin}`);
            
            if (event.data && event.data.type === 'RHAPSODY_READY') {
                debugLog('Received RHAPSODY_READY - connection established');
                isConnectedToRhapsody = true;
                rhapsodyWindow = event.source;
                updateConnectionStatus('connected', 'Connected to Rhapsody');
                
                // Send confirmation back
                rhapsodyWindow.postMessage({
                    type: 'TEAMCENTER_READY',
                    source: 'TeamCenter',
                    timestamp: Date.now()
                }, '*');
                debugLog('Sent TEAMCENTER_READY confirmation');
            }
        });

        // Drag and drop functionality
        function setupDragAndDrop() {
            const elementCards = document.querySelectorAll('.element-card');
            
            elementCards.forEach(card => {
                card.addEventListener('dragstart', function(e) {
                    debugLog(`Starting drag for: ${this.dataset.elementType} - ${this.querySelector('.element-name').textContent}`);
                    
                    this.classList.add('dragging');
                    
                    const dragData = {
                        source: 'TeamCenter',
                        elementType: this.dataset.elementType,
                        elementId: this.dataset.elementId,
                        elementName: this.querySelector('.element-name').textContent,
                        elementDescription: this.querySelector('.element-description').textContent,
                        properties: {
                            name: this.querySelector('.element-name').textContent,
                            description: this.querySelector('.element-description').textContent,
                            id: this.dataset.elementId,
                            sourceApplication: 'TeamCenter'
                        },
                        metadata: {
                            dragStartTime: Date.now(),
                            userAgent: navigator.userAgent
                        }
                    };
                    
                    // Set data for HTML5 drag and drop
                    e.dataTransfer.setData('application/x-rhapsody-element', JSON.stringify(dragData));
                    e.dataTransfer.setData('text/plain', `${dragData.elementType}: ${dragData.elementName}`);
                    e.dataTransfer.effectAllowed = 'copy';
                    
                    // Notify Rhapsody that drag started
                    if (isConnectedToRhapsody && rhapsodyWindow) {
                        rhapsodyWindow.postMessage({
                            type: 'RHAPSODY_DRAG_START',
                            data: dragData
                        }, '*');
                        debugLog('Sent RHAPSODY_DRAG_START message');
                    }
                });
                
                card.addEventListener('dragend', function(e) {
                    debugLog('Drag ended');
                    this.classList.remove('dragging');
                    
                    // Notify Rhapsody that drag ended
                    if (isConnectedToRhapsody && rhapsodyWindow) {
                        rhapsodyWindow.postMessage({
                            type: 'RHAPSODY_DRAG_END'
                        }, '*');
                        debugLog('Sent RHAPSODY_DRAG_END message');
                    }
                });
            });
        }

        // Handle window closing
        window.addEventListener('beforeunload', function() {
            if (isConnectedToRhapsody && rhapsodyWindow) {
                rhapsodyWindow.postMessage({
                    type: 'TEAMCENTER_CLOSING',
                    source: 'TeamCenter'
                }, '*');
                debugLog('Sent TEAMCENTER_CLOSING message');
            }
        });

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM loaded - initializing application');
            initializeConnection();
            setupDragAndDrop();
        });
    </script>
</body>
</html>
